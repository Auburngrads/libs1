---
output: html_document
---

__Write a computer program to do the following, using the shock absorber data from Example 9.4 to illustrate the program's use:__

a. __Sample with replacement to obtain a sample of size $n=38$ shock absorbers from the 38 rows of Appendix Table C.2__

`r teachingSMRD:::solution()$begin`
We can easily sample, with replacement, from the shockabsorber data set to create a bootstrap sample of 38 observations using `sample( )`.  Note that in the code below `boot` includes the sampled times as well as the censoring indicator corresponding to that observation

```{r echo=TRUE}
boot <- shockabsorber[sample(1:38, 38, replace = TRUE),]
Shockboot.ld <- frame.to.ld(frame = boot, 
                            response.column = 1, 
                            censor.column = 3)
```
`r teachingSMRD:::solution()$end`

b. __Compute the Weibull distribution ML bootstrap estimates $(\widehat{\mu}^{*},\widehat{\sigma}^{*})$ for this sample.__

`r teachingSMRD:::solution()$begin`
Using the bootstrap sample of shock absorbers from part (a) the maximum likelihood bootstrap estimates, $\widehat{\mu}^*_{_{MLE}},\widehat{\sigma}^*_{_{MLE}}$ are found by fitting a Weibull distribution to the times to failure associated with the sampled shock absorbers. In R we can find these values several ways:

__Using the "survival" package:__ The survival package requires that we first creat a "Surv" object.  Since we've already created a "life.data" object, this conversion is easy

```{r echo=TRUE}
Shockboot.Surv <- ld.to.surv(Shockboot.ld)
```

We can extract $\widehat{\mu}^*_{_{MLE}},\widehat{\sigma}^*_{_{MLE}}$ from a "survreg" (Survival Regression) object by first running

```{r echo=TRUE}
SR <- survreg(Shockboot.Surv~1, dist = "weibull")
```

From the survreg object `SR`, the maximum likelihood parameter values are reported as $\widehat{\mu}^*_{_{MLE}},\widehat{\sigma}^*_{_{MLE}}$ from the smallest extreme value distribution.  For this sample these values are

$$
\widehat{\mu}^*_{_{MLE}},\widehat{\sigma}^*_{_{MLE}}=`r c(SR$coef,SR$scale)`
$$

__Using the SMRD package:__ By using only the function from the SMRD pacakge we can compute $\widehat{\mu}^*_{_{MLE}},\widehat{\sigma}^*_{_{MLE}}$ and present them in a \LaTeX\ table very quickly using

```{r, echo=TRUE}
mle.table <- print(mlest(Shockboot.ld, 
                         distribution = "Weibull"))$mle.table

knitr::kable(mle.table,
             digits = c(0,4,4,2,2),
             format = 'pandoc',
             caption = "Weibull parameter estimates for the shock absorber bootstrap sample")
```

Comparing the results from both packages shows that they are equivalent.
`r teachingSMRD:::solution()$end`

c. __Compute the bootstrap studentized quantile estimate $Z_{\log(\widehat{t}^{*}_{.1})}=[\log(\widehat{t}^{*}_{.1})-\log(\widehat{t}^{*}_{.1})]/\widehat{se}_{\log(\widehat{t}^{*}_{.1})}$__

`r teachingSMRD:::solution()$begin`
The bootstrap studentized quantile estimate (top of pg. 209) for $p=0.1$ is expressed as

$$
Z_{\log(\widehat{t}^*_{0.1})}=\frac{\log(\widehat{t}^*_{0.1})-\log(\widehat{t}_{0.1})}{\widehat{se}_{\log(\widehat{t}^*_{0.1})}}.
$$

Each bootstrap sample generates a single observation of $Z_{\log(\widehat{t^{*}_{0.1}})}$.  This requires first computing $\log(\widehat{t}_{0.1})$ using the set of $38$ observations from the original shock absorber test data.  The value for $\log(\widehat{t}_{0.1})$ may be found by inverting the Weibull cdf in location-scale form and substituting $\widehat{\mu}_{_{MLE}}\; \text{and}\;\widehat{\sigma}_{_{MLE}}$, resulting in

$$
\log(\widehat{t}_{0.1})=\widehat{\mu}_{_{MLE}}+\widehat{\sigma}_{_{MLE}}\times\log\left(-\log(.9)\right)=10.23+0.3164(-2.2504)=9.518 \text{ Kilometers}.
$$

Then, in a similar manner, $\log(\widehat{t}^{*}_{0.1})$ is computed for each bootstrap sample.  For the sample produced in part (a) this value is

$$
\log(\widehat{t}^{*}_{0.1})=\widehat{\mu}^*_{_{MLE}}+\widehat{\sigma}^*_{_{MLE}}\times\log\left(-\log(.9)\right)=`r round(SR$coef,digits = 3)`+`r round(SR$scale,digits = 3)`(-2.2504)=`r t.1.boot <- round(SR$coef + SR$scale*(-2.2504),digits = 3); t.1.boot` \text{ Kilometers}.
$$

Finally, $\widehat{se}_{\log(\widehat{t}^*_{0.1})}$ is computed by first using Equation (8.12) to find

$$
\widehat{se}_{\widehat{t}^*_{0.1}}=\widehat{t}^{*}_{0.1}\left[\widehat{Var}(\widehat{\mu}^{*})+2\times\log(-\log(0.9))\times\widehat{Cov}(\widehat{\mu}^{*},\widehat{\sigma}^{*})+\log(-\log(0.9))^{2}\times\widehat{Var}(\widehat{\sigma^{*}})\right]^{0.5}
$$

Then, $\widehat{se}_{\log(\widehat{t}^{*}_{0.1})}$ is found using the Delta Method a second time as shown in Section 7.3.3, where Equation 7.12 shows that

$$
\widehat{se}_{\log(\widehat{t}^{*}_{0.1})}=\frac{\widehat{se}_{\widehat{t}^*_{0.1}}}{\widehat{t}^*_{0.1}}.
$$

The variance and covariance terms in the above equation can be produced from either the "survreg" object or the "life.data" object.
   
```{r echo=TRUE, results='asis'}
knitr::kable(SR$var,
             digits = c(0,7,7),
             format = 'pandoc',
             caption = "Covariance matrix (survreg) for the shockabsorber bootstrap sample")
```

```{r echo=TRUE, results='asis'}
vcv <- print(mlest(Shockboot.ld, distribution = "Weibull"))$vcv

knitr::kable(vcv,
             format = 'pandoc',
             caption = "Covariance matrix (from SMRD) for the shockabsorber bootstrap sample",
             digits = c(0,7,7))
```

Therefore, 

$$
\widehat{se}_{\log(\widehat{t}^{*}_{0.1})}=\left[`r vcv[1]` +2\times(-2.2504)(`r vcv[2]`) + (-2.2504)^{2} \times `r vcv[4]`\right]^{0.5}=`r se.t.1.boot<-round(sqrt(vcv[1]+2*-2.2504*vcv[2]+ (-2.2504)^2* vcv[4]),digits = 3) ;se.t.1.boot`
$$

and for this sample a single observation is produced 

$$
Z_{\log(\widehat{t^{*}_{0.1}})}=\frac{`r t.1.boot`-9.518}{`r se.t.1.boot`}=`r round((t.1.boot-9.518)/se.t.1.boot,digits = 5)`
$$
`r teachingSMRD:::solution()$end`

d. __Repeat steps (a) to (c) 2000 times to get 2000 values of $Z_{log(\widehat{t}^{*}_{.1})}.$  Make a histogram of these values to see the bootstrap distribution of $Z_{log(\widehat{t}^{*}_{.1})}.$  Find the $0.25$ and $.975$ quantiles of this distribution.__

`r teachingSMRD:::solution()$begin`
```{r}
Q <- 0.1
B <- 2000
qsev <- SMRD:::qsev
Z_boot_t.q       <- rep(NA,B)
Z_boot_log_theta <- rep(NA,B)
Z_boot_mu   	   <- rep(NA,B)	
Z_boot_sig  	   <- rep(NA,B)	
boot_t.q 	       <- rep(NA,B)
boot_t.q_se	     <- rep(NA,B)

# Initial Estimates from Original Data

Shockabsorber.ld   <- frame.to.ld(frame = shockabsorber, 
                                  response.column = 1)
Shockabsorber.Surv <- ld.to.surv(Shockabsorber.ld)

SR <- survreg(Shockabsorber.Surv~1, dist = "weibull")

t.q    <- exp(SR$coef+SR$scale*qsev(.1))
t.q_se <- t.q*sqrt(SR$var[1] + 
                   2 * qsev(.1) * SR$var[2] * SR$scale + 
                     SR$var[4] * (qsev(.1) * SR$scale)^2)

for (j in 1:B) {

boot <- shockabsorber[sample(1:38, 38, replace = TRUE),]
Shockboot.ld <- frame.to.ld(frame = boot, 
                            response.column = 1)

Shockboot.Surv <- ld.to.surv(Shockboot.ld)
SRb <- survreg(Shockboot.Surv~1, dist = "weibull")

# Bootstrap Distribution for Quantile Values

boot_t.q[j] <- exp(SRb$coef+SRb$scal*qsev(.1))
  
boot_t.q_se[j] <- boot_t.q[j]*sqrt(SRb$v[1]+2*qsev(.1)*SRb$v[2]*SRb$scale+SRb$v[4]*(qsev(.1)*SRb$scale)^2)

Z_boot_t.q[j] <- (boot_t.q[j]-t.q)/boot_t.q_se[j]
}

# Return Bootstrap Confidence Intervals

CI_boot_t.q	<-c(t.q*exp(quantile(Z_boot_t.q,c(.025,.975))*t.q_se/t.q))
```

The histogram below illustrates the approximate distribution of the 2000 $Z_{\log(\widehat{t^{*}_{0.1}})}$ observations.

```{r, echo=FALSE, fig.cap="Histogram of nonparametric bootstrap studentized quantile estimates (2000 samples)"}
par(family = "serif")
hist(Z_boot_t.q, 
     col = "steelblue", 
     border = "white", 
     freq = F,
     xlab = parse(text = "Z[log(widehat(t)[0.1])]"), 
     las = 1, cex.axis = 1.1, cex.lab = 1.1, main = "")
```

Finding the $2.5\%$ and $97.5\%$ quantile values of the $Z_{\log(\widehat{t^{*}_{0.1}})}$ can then be accomplished using

```{r echo=TRUE, eval=FALSE}
quantile(Z_boot_t.q, c(.025,.975))
```

which results in quantile values of $`r quantile(Z_boot_t.q,.025)`$ and $`r quantile(Z_boot_t.q,.975)`$.
`r teachingSMRD:::solution()$end`

e. __Use the results in part (d) to compute a bootstrap confidence interval for $t_{.1}.$  Compare with the interval in Table 9.2.  Why are they not exactly the same?  What could be done to assure better agreement in such a comparison?__

`r teachingSMRD:::solution()$begin`
Finally, a $95\%$ confidence interval for $\widehat{t}_{0.1}$ may be produced using Equation 8.11 where the upper and lower bounds of this interval were calculated as 

$$
\left[\underline{t_{0.1}},\overline{t_{0.1}}\right]=[`r CI_boot_t.q`]
$$

These upper and lower coonfidence limits differ from those shown in Table 9.2 beacause the table limits were found using $10,000$ bootstrap samples rather than $2,000.$ Further, the table limits were found using a parametric bootstrap procedure wherein the confidence intervals are based on a larger range of observations than is possible using the nonparametric approach.

Interestingly, by re-running the nonparametric analysis with $10,000$ bootstrap samples did not result in a significant change in the upper and lower confidence limits. 
`r teachingSMRD:::solution()$end`
